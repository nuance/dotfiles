name: Update lockfiles

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0' # Every Sunday at midnight UTC

jobs:

  update:
    name: Stage new version
    runs-on: macos-11

    steps:

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Configure Homebrew cache
      uses: actions/cache@v2
      with:
        path: |
          ~/Library/Caches/Homebrew/emacs-plus*
        key: brew-${{ runner.os }}-${{ hashFiles('Brewfile.lock.json') }}

    - name: Clean existing install
      run: |
        brew bundle cleanup --force

    - name: Ignore MAS apps
      run: sed -i .bak -e 's/^mas/#mas/g' Brewfile

    - name: Make
      run: make

    - name: Update
      run: make update

    - name: Reset ignore for MAS apps
      run: git checkout -- Brewfile

    - name: Push commit with updated inputs
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com

          git commit -am "Update lockfiles"
        git push
